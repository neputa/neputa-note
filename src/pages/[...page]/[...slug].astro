---
import BlogPost from '@/layouts/BlogPost'
import CodeBlock from '@/components/mdx/CodeBlock'
import Table from '@/components/mdx/Table'
import ListRelatedPosts from '@/components/widgets/ListRelatedPosts'
import Share from '@/components/ui/Share'
import TableOfContentsDetails from '@/components/widgets/TableOfContentsDetails'
import { getPermalink, getPosts } from '@/utils'
import SButton from '@/components/mdx/SButton'
import Disqus from '@/components/widgets/Disqus'
import { disqusConfig } from '@/data/disqus.config'
import BlogImage from '@/components/mdx/BlogImage'
import Tag from '@/components/ui/Tag'
import ToTopIcon from '@/components/icons/ToTopIcon'
import ArrowLeft from '@/components/icons/ArrowLeft'
import ArrowRight from '@/components/icons/ArrowRight'
import '../../styles/blockquote.css'

const posts = await getPosts()

export async function getStaticPaths() {
  const posts = await getPosts()
  const postsLength = posts.length

  return posts.map((post, i) => ({
    params: { slug: post.slug },
    props: {
      post,
      prevPost: i + 1 === postsLength ? undefined : posts[i + 1],
      nextPost: i === 0 ? undefined : posts[i - 1]
    }
  }))
}

const { post, prevPost, nextPost } = Astro.props
const { slug } = post
const tags = post.data.tags
const MAX_POSTS = 6
const { Content, headings, remarkPluginFrontmatter } = await post.render()
const disqusEnabled = disqusConfig.enabled
---

<BlogPost
  id={post.id}
  data={post.data}
  headings={headings}
  readTime={remarkPluginFrontmatter.minutesRead}
>
  <div class='mt-8 flex w-full flex-col gap-10 md:flex-row md:gap-4 lg:gap-6'>
    <!-- aside  -->
    <aside class='w-full flex-shrink-0 md:w-[20%]'>
      <div
        id='sidebar-container'
        class='w-full overflow-auto pr-2 transition-all duration-200 md:max-h-[calc(100vh-1rem)]'
      >
        <Share title={post.data.title} />
        {headings && headings.length > 0 && <TableOfContentsDetails {headings} />}
        <button
          id='toTop-button-md'
          class='mb-12 mt-4 hidden w-full place-items-center gap-1 no-underline md:flex'
        >
          <ToTopIcon />
          <p class='m-0 p-0'>トップへ戻る</p>
        </button>
      </div>
    </aside>

    <!-- post -->
    <article class='w-full max-w-full flex-1 md:w-[80%]'>
      <div class='prose prose-quoteless mb-12 min-w-full dark:prose-invert md:prose-lg xl:prose-xl'>
        <Content components={{ 'code-block': CodeBlock, SButton, img: BlogImage, table: Table }} />
      </div>

      <div class='my-8'>
        <Share title={post.data.title} heading='' />
      </div>

      <div class='mb-16 flex flex-wrap gap-2 gap-y-4 md:gap-5'>
        {tags.map((tag: string) => <Tag tag={tag} />)}
      </div>

      <!-- related posts -->
      <footer>
        <h2 class='mb-6 border-t border-t-gray-300 pt-6 text-lg font-bold dark:text-white'>
          閲覧した記事からのおすすめ
        </h2>
        <ListRelatedPosts slug={slug} tags={tags} maxPosts={MAX_POSTS} />
        <div
          class='gird-rows-2 mt-16 grid w-full justify-between gap-4 border-t border-t-gray-300 pt-6 text-black dark:text-white md:grid-cols-2 md:gap-2'
        >
          <!-- Next Button -->
          {
            nextPost ? (
              <a
                href={getPermalink(nextPost.slug, 'post')}
                class='flex max-h-14 w-full gap-1 rounded-lg border border-gray-300 p-4 hover:bg-gray-100 hover:text-gray-700  dark:border-gray-700 dark:bg-transparent dark:hover:bg-gray-700 dark:hover:text-white'
              >
                <sapn class='w-6'>
                  <ArrowLeft />
                </sapn>
                <span class='line-clamp-1 overflow-hidden text-sm'>{nextPost.data.title}</span>
              </a>
            ) : (
              <span />
            )
          }

          <!-- Previous Button -->
          {
            prevPost ? (
              <a
                href={getPermalink(prevPost.slug, 'post')}
                class='flex max-h-14 w-full gap-1 rounded-lg border border-gray-300 p-4 hover:bg-gray-100  hover:text-gray-700 dark:border-gray-700 dark:bg-transparent dark:hover:bg-gray-700 dark:hover:text-white'
              >
                <span class='line-clamp-1 overflow-hidden text-sm'>{prevPost.data.title}</span>
                <sapn class='w-6'>
                  <ArrowRight />
                </sapn>
              </a>
            ) : (
              <span />
            )
          }
        </div>
      </footer>
    </article>
  </div>

  {disqusEnabled && <Disqus />}
</BlogPost>

<script>
  const toTopScroll = () => {
    const toTopBtn = document.getElementById('toTop-button-md') as HTMLButtonElement

    toTopBtn &&
      toTopBtn.addEventListener('click', function () {
        window.scrollTo({
          top: 0,
          behavior: 'smooth'
        })
      })
  }

  const initStickysidebar = () => {
    const sidebarContainer = document.getElementById('sidebar-container') as HTMLElement
    const aside = sidebarContainer?.parentElement as HTMLElement

    if (!sidebarContainer || !aside) return

    // メディアクエリチェック（md以上でのみ動作）
    const mediaQuery = window.matchMedia('(min-width: 768px)')

    const handleScroll = () => {
      if (!mediaQuery.matches) {
        // モバイルでは固定しない
        sidebarContainer.style.position = 'static'
        sidebarContainer.style.top = 'auto'
        return
      }

      const rect = aside.getBoundingClientRect()
      const sidebarHeight = sidebarContainer.offsetHeight
      const windowHeight = window.innerHeight
      const scrollY = window.scrollY

      // サイドバーがビューポートより小さい場合のみ固定
      if (sidebarHeight <= windowHeight - 16) {
        // 16px = top margin
        if (rect.top <= 8) {
          // 8px = top offset
          // 固定位置に設定
          sidebarContainer.style.position = 'fixed'
          sidebarContainer.style.top = '8px'
          sidebarContainer.style.width = `${rect.width}px`
          sidebarContainer.style.zIndex = '10'
        } else {
          // 通常位置に戻す
          sidebarContainer.style.position = 'static'
          sidebarContainer.style.top = 'auto'
          sidebarContainer.style.width = 'auto'
          sidebarContainer.style.zIndex = 'auto'
        }
      }
    }

    // メディアクエリの変更を監視
    const handleMediaChange = (e: MediaQueryListEvent) => {
      if (!e.matches) {
        // モバイルに戻った時は固定を解除
        sidebarContainer.style.position = 'static'
        sidebarContainer.style.top = 'auto'
        sidebarContainer.style.width = 'auto'
        sidebarContainer.style.zIndex = 'auto'
      }
    }

    // イベントリスナーを設定
    window.addEventListener('scroll', handleScroll, { passive: true })
    window.addEventListener('resize', handleScroll, { passive: true })
    mediaQuery.addEventListener('change', handleMediaChange)

    // 初回実行
    handleScroll()

    // クリーンアップ関数を返す
    return () => {
      window.removeEventListener('scroll', handleScroll)
      window.removeEventListener('resize', handleScroll)
      mediaQuery.removeEventListener('change', handleMediaChange)
    }
  }

  // 初期化
  toTopScroll()
  const cleanupSidebar = initStickysidebar()

  // Astroのページ遷移時に再初期化
  document.addEventListener('astro:after-swap', () => {
    toTopScroll()
    initStickysidebar()
  })
</script>

<style is:global>
  lite-youtube {
    @apply my-8;
  }
</style>
